import json
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns

plt.style.use("ggplot")
plt.rcParams["figure.dpi"] = 300


def load_data(path):
    with open(path, "r", encoding="utf-8") as f:
        raw = json.load(f)
    records = [item["result"] for item in raw if "result" in item]
    return pd.DataFrame(records)


def find_event_column(df):
    for col in ["EventCode", "EventID", "eventcode", "eventid"]:
        if col in df.columns:
            return col
    return None


def plot_top_eventcodes(df, filename):
    event_col = find_event_column(df)
    if not event_col:
        return

    top_events = (
        df[event_col]
        .value_counts()
        .head(10)
        .rename_axis("Event")
        .reset_index(name="count")
    )

    fig, ax = plt.subplots(figsize=(12, 6))
    sns.barplot(data=top_events, x="Event", y="count",
                ax=ax, color="steelblue")

    ax.set_title("Топ-10 EventCode / EventID")
    ax.tick_params(axis="x", rotation=45)

    plt.tight_layout()
    plt.savefig(filename)
    plt.show()


def plot_top_destinations(df, filename):
    if "dest" not in df.columns:
        return

    top_dest = df["dest"].value_counts().head(10)

    fig, ax = plt.subplots(figsize=(14, 6))
    sns.barplot(x=top_dest.index, y=top_dest.values,
                ax=ax, color="darkorange")

    ax.set_title("Топ-10 DNS-адресов (dest)")
    ax.tick_params(axis="x", rotation=45)

    plt.tight_layout()
    plt.savefig(filename)
    plt.show()


def plot_dns_eventcodes(df, filename):
    if "sourcetype" not in df.columns:
        return

    dns_df = df[df["sourcetype"].str.contains("DNS", case=False, na=False)]
    if dns_df.empty:
        return

    event_col = find_event_column(dns_df)
    if not event_col:
        return

    dns_top = (
        dns_df[event_col]
        .value_counts()
        .head(10)
        .rename_axis("Event")
        .reset_index(name="count")
    )

    fig, ax = plt.subplots(figsize=(10, 5))
    sns.barplot(data=dns_top, x="Event", y="count",
                ax=ax, color="mediumseagreen")

    ax.set_title("EventCode в DNS-событиях")
    ax.tick_params(axis="x", rotation=45)

    plt.tight_layout()
    plt.savefig(filename)
    plt.show()


if __name__ == "__main__":
    df = load_data("botsv1.json")
    plot_top_eventcodes(df, "top10_eventcode_dz11.png")
    plot_top_destinations(df, "top10_dns_dest_dz11.png")
    plot_dns_eventcodes(df, "dns_only_events_dz11.png")
